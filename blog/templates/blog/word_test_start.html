{% extends 'blog/base.html' %}

{% block content %}
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const buttons = document.querySelectorAll(".answer-btn"); // Все кнопки с вариантами
        const form = document.getElementById("quiz-form"); // Форма для отправки
        const resultMessage = document.getElementById("result-message"); // Сообщение о результате
        const clockDiv = document.getElementById("clockdiv"); // Таймер
        const question_wordDiv = document.querySelector("[data-id='question_word-div']"); // Контейнер для question.kanji
        const optionsDiv = document.querySelector("[data-id='options-div']"); // Контейнер для кнопок
        const clockDiv_hide = document.getElementById("clockdiv_hide"); // Таймер
        const progressBar = document.querySelector(".progress-bar"); // Полоска прогресса
        const progress = document.querySelector(".progress"); // Полоска прогресса
        let timeInterval_hide; // Переменная для хранения интервала таймера
        const totalDuration = 10; // Таймер на 10 секунд
        let timeInterval; // Переменная для хранения интервала таймера

        buttons.forEach((button) => {
            button.addEventListener("click", () => {
                // Делаем все кнопки неактивными
                buttons.forEach((btn) => btn.disabled = true);

                // Проверяем, правильный ли ответ
                const isCorrect = button.getAttribute("data-correct") === "true";

                if (isCorrect) {
                    // Если ответ правильный
                    button.classList.add("btn-success");
                    resultMessage.style.color = "green";
                    resultMessage.innerText = "Правильно!";
                } else {
                    // Если ответ неправильный
                    button.classList.add("btn-danger");
                    resultMessage.style.color = "red";
                    resultMessage.innerText = "Неправильно!";

                    // Подсвечиваем правильный ответ
                    buttons.forEach((btn) => {
                        if (btn.getAttribute("data-correct") === "true") {
                            btn.classList.add("btn-success");
                        }
                    });
                }

                // Показываем сообщение о результате
                resultMessage.style.display = "block";

                // Скрываем таймер и очищаем интервал
                clockDiv.style.display = "none";
                clearInterval(timeInterval); // Останавливаем таймер

                // Устанавливаем значение для отправки
                const hiddenInput = document.createElement("input");
                hiddenInput.type = "hidden";
                hiddenInput.name = "user_answer";
                hiddenInput.value = button.value;
                form.appendChild(hiddenInput);
                // Задержка перед отправкой формы
                setTimeout(() => {
                    form.submit();
                }, 1000); // Задержка 1 секунда
            });
        });

        // Функция для отсчета времени
        function getTimeRemaining(endtime) {
            const t = Date.parse(endtime) - Date.parse(new Date());
            const seconds = Math.floor((t / 1000) % 60);
            const minutes = Math.floor((t / 1000 / 60) % 60);
            const hours = Math.floor((t / (1000 * 60 * 60)) % 24);
            const days = Math.floor(t / (1000 * 60 * 60 * 24));
            return {
                total: t,
                days: days,
                hours: hours,
                minutes: minutes,
                seconds: seconds
            };
        }

        function initializeClock(id, endtime) {
            var clock = document.getElementById(id);
            
            function updateClock() {
                var t = getTimeRemaining(endtime);
                clock.innerHTML = 'Seconds: ' + t.seconds;
                if (t.total <= 0) {
                    clearInterval(timeInterval);
                    clock.style.display = "none"; // Скрыть таймер, когда время вышло
                    
                    // Когда время вышло, считаем ответ неправильным и переходим к следующему вопросу
                    resultMessage.style.color = "red";
                    resultMessage.innerText = "Время истекло! Неправильно!";
                    resultMessage.style.display = "block";

                    // Останавливаем таймер и скрываем его
                    clockDiv.style.display = "none";
                    
                    // Устанавливаем неправильный ответ
                    const incorrectAnswerButton = document.querySelector('.answer-btn[data-correct="false"]');
                    const hiddenInput = document.createElement("input");
                    hiddenInput.type = "hidden";
                    hiddenInput.name = "user_answer";
                    hiddenInput.value = incorrectAnswerButton.value;
                    form.appendChild(hiddenInput);

                    // Задержка перед отправкой формы
                    setTimeout(() => {
                        form.submit();
                    }, 1000); // Задержка 1 секунда
                }
            }
            updateClock(); // Запустите функцию один раз, чтобы избежать задержки
            timeInterval = setInterval(updateClock, 1000); // Сохраняем интервал для остановки
        }
        // Устанавливаем конечное время для таймера (например, через 1 минуту)
        var deadline = new Date(Date.parse(new Date()) + 300 * 1000);
        initializeClock('clockdiv', deadline);
// ////////////////////////////////////////////////////////////////////////////////
        // Функция для отсчета времени
        // console.log("в начале totalDuration:", totalDuration);


        function getTimeRemaining_hide(endtime) {
            const t = Date.parse(endtime) - Date.parse(new Date());
            const seconds = Math.floor((t / 1000) % 60);
            const percentage = (t / (4 * 1000)) * 100;
            console.log("внутри функции totalDuration:", 4);
            progressBar.style.width = `${Math.max(0, percentage)}%`;
            return { total: t, seconds: seconds };
        }
        
        function initializeClock_hide(id, endtime) {
            const clock = document.getElementById(id);
            optionsDiv.style.display = "none";
            function updateClock_hide() {
                const t = getTimeRemaining_hide(endtime);
                clock.innerHTML = `Seconds: ${t.seconds}`;
                
                if (t.total < 0) {
                    clearInterval(timeInterval_hide);
                    clock.style.display = "none"; // Скрыть таймер
                    question_wordDiv.style.display = "none";
                    optionsDiv.style.display = "";
                    progressBar.style.width = "0%"; // Полоска прогресса опустошена
                    progress.style.display = "";
                }
            }
            updateClock_hide(); // Запустите функцию один раз, чтобы избежать задержки
            timeInterval_hide = setInterval(updateClock_hide, 1000);
        }
        // Получаем значение question_time из data-атрибута
        const questionTime = parseInt(clockDiv_hide.getAttribute("data-question_time"), 10) || 4;
        const deadline_hide = new Date(Date.parse(new Date()) + questionTime * 1000);
        initializeClock_hide('clockdiv_hide', deadline_hide);
    });
</script>

<div class="container py-5">
    <h1 class="text-center mb-4">Тестирование</h1>
    <form id="quiz-form" method="post" action="{% url 'word_test_next' %}">
        {% csrf_token %}
        <!-- Ограничение ширины карточки -->
        <div class="col-md-6 mx-auto">
            <div class="card my-3 shadow-sm">
                <div class="card-body">
                    <!-- Общая информация -->
                    <h5 class="card-title text-center mb-3">
                        <span>Осталось времени: 
                            <div id="clockdiv_hide"></div>
                        </span>
                        <span>Всего вопросов: </span>
                        {% if total %}
                        {{ total }}
                        {% else %}
                        lenqs: {{ len_qs }}
                        {% endif %}
                    </h5>
                    <h5 class="card-title text-center mb-3">
                        Вопрос №:
                        {% with current_index|add:1 as current_index %}
                        {{ current_index|default:"1" }}
                        {% endwith %}
                    </h5>
                    <!-- Вопрос и ответ -->
                    <hr class="my-1"> <!-- Разделитель -->
                    <div data-id = 'question_word-div'>
                        <h5 class="card-title text-center mb-4">{{ question.question_word }}</h5>
                    </div>
                    <div class="progress" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                        <div class="progress-bar text-bg-warning" style="width: 100%;  transition: width 1s linear;"></div>
                    </div>
                    <!-- Варианты ответов (кнопки) -->
                    <div class="row g-3" data-id="options-div">
                        {% for option in question.options %}
                        <div class="col-6">
                            <button 
                                type="submit" 
                                name="user_answer" 
                                value="{{ option }}"
                                data-correct="{% if option == question.correct %}true{% else %}false{% endif %}" 
                                class="btn btn-lg btn-outline-primary w-100 shadow-sm answer-btn">
                                {{ option }}
                            </button>
                        </div>
                        {% endfor %}
                    </div>
                    <div id="result-message" class="text-center mt-3" style="display: none;"></div>
                    <div class="d-flex justify-content-center align-items-center" >
                        <!-- Таймер -->
                        <div id="clockdiv">                        
                        </div>
                    </div>
                </div>
            </div>
        </div>        
    </form>
</div>
{% endblock %}
